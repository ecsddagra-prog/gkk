import { useState, useEffect, useMemo, useCallback } from 'react'
import { useRouter } from 'next/router'
import { supabase } from '../lib/supabase'
import axios from 'axios'
import toast from 'react-hot-toast'
import Link from 'next/link'

export default function BookService({ user }) {
  const router = useRouter()
  const [services, setServices] = useState([])
  const [categories, setCategories] = useState([])
  const [cities, setCities] = useState([])
  const [addresses, setAddresses] = useState([])
  const [profile, setProfile] = useState(null)
  const [selectedCategory, setSelectedCategory] = useState(null)
  const [selectedServiceId, setSelectedServiceId] = useState(null)
  const [selectedSubServiceId, setSelectedSubServiceId] = useState(null)
  const [selectedCity, setSelectedCity] = useState(null)
  const [selectedAddress, setSelectedAddress] = useState(null)
  const [cityAutoDetecting, setCityAutoDetecting] = useState(false)
  const [servicesLoading, setServicesLoading] = useState(false)
  const [formData, setFormData] = useState({
    service_address: '',
    service_lat: '',
    service_lng: '',
    scheduled_date: '',
    user_quoted_price: ''
  })
  const [bookingFor, setBookingFor] = useState('self')
  const [otherContact, setOtherContact] = useState({ name: '', phone: '' })
  const [loading, setLoading] = useState(true)
  const [submitting, setSubmitting] = useState(false)
  const [quoteLoading, setQuoteLoading] = useState(false)

  useEffect(() => {
    if (!user) {
      router.push('/login')
      return
    }
    loadData()
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [user])

  const determineDefaultCity = (citiesList, profileData, addressesData) => {
    const byProfile = profileData?.current_city_id || profileData?.default_city_id
    if (byProfile && citiesList.some(city => city.id === byProfile)) {
      return byProfile
    }

    const defaultAddress = (addressesData || []).find(addr => addr.is_default)
    if (defaultAddress) {
      const cityMatch = citiesList.find(city => city.name.toLowerCase() === defaultAddress.city?.toLowerCase())
      if (cityMatch) return cityMatch.id
    }

    return citiesList[0]?.id || null
  }

  const loadData = async () => {
    try {
      const token = (await supabase.auth.getSession()).data.session?.access_token
      const { data } = await axios.get('/api/catalog/bootstrap', {
        headers: { Authorization: `Bearer ${token}` }
      })

      setCities(data.cities || [])
      setCategories(data.categories || [])
      setProfile(data.profile || null)
      setAddresses(data.addresses || [])

      const defaultCityId = determineDefaultCity(data.cities || [], data.profile, data.addresses)
      setSelectedCity(defaultCityId)

      if (data.addresses && data.addresses.length > 0) {
        const defaultAddress = data.addresses.find(addr => addr.is_default) || data.addresses[0]
        handleAddressSelect(defaultAddress)
      }
    } catch (error) {
      console.error('Error loading data:', error)
      toast.error(error.response?.data?.error || 'Failed to load data')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    if (selectedCity && selectedCategory) {
      loadServices()
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    const handleAddressSelect = (address) => {
      if (!address) return
      setSelectedAddress(address.id)
      setFormData(prev => ({
        ...prev,
        service_address: `${address.address_line1}${address.address_line2 ? `, ${address.address_line2}` : ''}, ${address.city}, ${address.pincode || ''}`,
        service_lat: address.latitude,
        service_lng: address.longitude
      }))

      const matchingCity = cities.find(city => city.name?.toLowerCase() === address.city?.toLowerCase())
      if (matchingCity && matchingCity.id !== selectedCity) {
        setSelectedCity(matchingCity.id)
      }
    }

    const autoDetectCityFromLocation = useCallback(() => {
      if (cityAutoDetecting || typeof window === 'undefined') return
      if (!navigator.geolocation) {
        toast.error('Geolocation is not supported by your browser')
        return
      }

      if (!cities.length) {
        toast.error('No cities configured yet')
        return
      }

      setCityAutoDetecting(true)
      navigator.geolocation.getCurrentPosition(async (position) => {
        try {
          const { latitude, longitude } = position.coords
          const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`)
          const data = await response.json()
          const detectedCityName = data.address?.city || data.address?.town || data.address?.village || data.address?.state_district

          if (!detectedCityName) {
            toast.error('Unable to detect your city from location')
            return
          }

          const matchedCity = cities.find(city => city.name?.toLowerCase() === detectedCityName.toLowerCase())
          if (!matchedCity) {
            toast.error(`Services are not available in ${detectedCityName} yet`)
            return
          }

          setSelectedCity(prev => prev || matchedCity.id)
          setFormData(prev => ({
            ...prev,
            service_address: prev.service_address || data.display_name || '',
            service_lat: latitude,
            service_lng: longitude
          }))

          if (user?.id) {
            const { error: updateError } = await supabase
              .from('users')
              .update({
                current_city_id: matchedCity.id,
                current_lat: latitude,
                current_lng: longitude
              })
              .eq('id', user.id)

            if (updateError) {
              console.warn('Failed to persist user location', updateError)
            }
          }
        } catch (error) {
          console.error('Auto detect city error:', error)
          toast.error('Failed to auto-detect city')
        } finally {
          setCityAutoDetecting(false)
        }
      }, (error) => {
        console.error('Geolocation error:', error)
        toast.error('Unable to fetch your current location')
        setCityAutoDetecting(false)
      }, { enableHighAccuracy: true })
    }, [cityAutoDetecting, cities, user?.id])

    useEffect(() => {
      if (!loading && !selectedCity && cities.length > 0) {
        autoDetectCityFromLocation()
      }
    }, [loading, selectedCity, cities.length, autoDetectCityFromLocation])

    const activeService = useMemo(() => services.find(service => service.id === selectedServiceId), [services, selectedServiceId])
    const activeSubService = useMemo(() => activeService?.sub_services?.find(sub => sub.id === selectedSubServiceId), [activeService, selectedSubServiceId])

    const chargeSummary = useMemo(() => ({
      base: activeSubService?.base_charge ?? activeService?.base_price ?? 0,
      hourly: activeSubService?.per_hour_charge ?? null,
      min: activeService?.min_price ?? null,
      max: activeService?.max_price ?? null
    }), [activeService, activeSubService])

    const handleSubmit = async (e) => {
      e.preventDefault()

      if (!selectedServiceId || !selectedCity || !formData.service_address) {
        toast.error('Please fill all required fields')
        return
      }

      if (bookingFor === 'other' && (!otherContact.name || !otherContact.phone)) {
        toast.error('Please add name and phone for the person you are booking for')
        return
      }

      setSubmitting(true)

      try {
        const { data } = await axios.post('/api/bookings/create', {
          user_id: user.id,
          service_id: selectedServiceId,
          city_id: selectedCity,
          address_id: selectedAddress,
          service_address: formData.service_address,
          service_lat: formData.service_lat,
          service_lng: formData.service_lng,
          scheduled_date: formData.scheduled_date || null,
          user_quoted_price: formData.user_quoted_price || null,
          sub_service_id: selectedSubServiceId,
          sub_service_name: activeSubService?.name || activeService?.name,
          base_charge: chargeSummary.base,
          hourly_charge: chargeSummary.hourly,
          for_whom: bookingFor,
          other_contact: bookingFor === 'other' ? otherContact : null
        })

        toast.success('Booking created successfully!')
        router.push(`/booking/${data.booking.id}`)
      } catch (error) {
        toast.error(error.response?.data?.error || 'Failed to create booking')
      } finally {
        setSubmitting(false)
      }
    }

    const handleRateQuote = async () => {
      if (!selectedServiceId || !selectedCity || !formData.service_address) {
        toast.error('Please select service, city and address')
        return
      }

      setQuoteLoading(true)
      try {
        const token = (await supabase.auth.getSession()).data.session?.access_token

        const payload = {
          service_id: selectedServiceId,
          sub_service_id: selectedSubServiceId,
          city_id: selectedCity,
          address_id: selectedAddress,
          requested_price: formData.user_quoted_price || null,
          details: {
            service_address: formData.service_address,
            service_lat: formData.service_lat,
            service_lng: formData.service_lng,
            scheduled_date: formData.scheduled_date || null,
            for_whom: bookingFor,
            other_contact: bookingFor === 'other' ? otherContact : null,
            sub_service_name: activeSubService?.name || activeService?.name,
            base_charge: chargeSummary.base,
            hourly_charge: chargeSummary.hourly
          }
        }

        const { data } = await axios.post('/api/rate-quotes', payload, {
          headers: { Authorization: `Bearer ${token}` }
        })

        toast.success('Rate quote requested! Countdown started.')
        router.push(`/rate-quote/${data.rate_quote.id}`)
      } catch (error) {
        toast.error(error.response?.data?.error || 'Failed to request rate quote')
      } finally {
        setQuoteLoading(false)
      }
    }

    if (loading) {
      return (
        <div className="flex items-center justify-center min-h-screen">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
      )
    }

    return (
      <div className="min-h-screen bg-gray-50">
        <header className="bg-white shadow-sm">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div className="flex justify-between items-center">
              <Link href="/dashboard" className="text-blue-600 hover:text-blue-700">
                ← Back to Dashboard
              </Link>
              <h1 className="text-2xl font-bold text-blue-600">Book a Service</h1>
              <div></div>
            </div>
          </div>
        </header>

        <div className="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow-md p-6 space-y-6">
            {/* City Selection */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Select City *</label>
              <select
                required
                value={selectedCity || ''}
                onChange={(e) => setSelectedCity(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg"
              >
                <option value="">Select City</option>
                {cities.map(city => (
                  <option key={city.id} value={city.id}>{city.name}</option>
                ))}
              </select>
              <button
                type="button"
                onClick={autoDetectCityFromLocation}
                className="mt-2 text-sm text-blue-600 hover:text-blue-700 disabled:opacity-50"
                disabled={cityAutoDetecting}
              >
                {cityAutoDetecting ? 'Detecting location...' : 'Use my current location'}
              </button>
            </div>

            {/* Category Selection */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Service Category *</label>
              <select
                required
                value={selectedCategory || ''}
                onChange={(e) => {
                  setSelectedCategory(e.target.value)
                  setSelectedServiceId(null)
                  setSelectedSubServiceId(null)
                  setServices([])
                }}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg"
              >
                <option value="">Select Category</option>
                {categories.map(cat => (
                  <option key={cat.id} value={cat.id}>{cat.icon} {cat.name}</option>
                ))}
              </select>
            </div>

            {/* Service Selection */}
                    }}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  >
            <option value="">Select Service</option>
            {services.map(service => (
              <option key={service.id} value={service.id}>
                {service.name}
                {service.base_price ? ` • ₹${service.base_price}` : ''}
              </option>
            ))}
          </select>
                )}
        </div>
            )}

        {activeService?.sub_services?.length > 0 && (
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Sub-Service *</label>
            <select
              required
              value={selectedSubServiceId || ''}
              onChange={(e) => setSelectedSubServiceId(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            >
              <option value="">Select sub-service</option>
              {activeService.sub_services
                .filter(sub => sub.is_active)
                .map(sub => (
                  <option key={sub.id} value={sub.id}>
                    {sub.name} {sub.base_charge ? `- ₹${sub.base_charge}` : ''}
                  </option>
                ))}
            </select>
          </div>
        )}

        {(activeService || activeSubService) && (
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div className="flex justify-between mb-2">
              <span className="font-semibold text-blue-700">Base Charge</span>
              <span className="text-blue-900 font-bold">₹{chargeSummary.base || '—'}</span>
            </div>
            {chargeSummary.hourly && (
              <div className="flex justify-between mb-2">
                <span className="font-semibold text-blue-700">Per Hour</span>
                <span className="text-blue-900 font-bold">₹{chargeSummary.hourly}</span>
              </div>
            )}
            {(chargeSummary.min || chargeSummary.max) && (
              <div className="text-sm text-blue-600">
                Range: ₹{chargeSummary.min || chargeSummary.base} - ₹{chargeSummary.max || chargeSummary.base}
              </div>
            )}
          </div>
        )}

        {/* Address Selection */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Service Address *</label>
          {addresses.length > 0 ? (
            <div className="space-y-2 mb-4">
              {addresses.map(address => (
                <button
                  key={address.id}
                  type="button"
                  onClick={() => handleAddressSelect(address)}
                  className={`w-full text-left p-3 border rounded-lg ${selectedAddress === address.id
                    ? 'border-blue-600 bg-blue-50'
                    : 'border-gray-300 hover:border-gray-400'
                    }`}
                >
                  <div className="font-medium">{address.address_type}</div>
                  <div className="text-sm text-gray-600">
                    {address.address_line1}, {address.city}, {address.pincode}
                  </div>
                </button>
              ))}
            </div>
          ) : (
            <p className="text-sm text-gray-600 mb-2">No saved addresses. Please add an address.</p>
          )}
          <textarea
            required
            value={formData.service_address}
            onChange={(e) => setFormData({ ...formData, service_address: e.target.value })}
            placeholder="Enter service address"
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            rows={3}
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Booking For *</label>
          <div className="flex gap-4">
            <label className="flex items-center gap-2 text-sm">
              <input
                type="radio"
                checked={bookingFor === 'self'}
                onChange={() => setBookingFor('self')}
              />
              Self
            </label>
            <label className="flex items-center gap-2 text-sm">
              <input
                type="radio"
                checked={bookingFor === 'other'}
                onChange={() => setBookingFor('other')}
              />
              Someone Else
            </label>
          </div>
          {bookingFor === 'other' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <input
                type="text"
                placeholder="Person's Name"
                value={otherContact.name}
                onChange={(e) => setOtherContact({ ...otherContact, name: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                required
              />
              <input
                type="tel"
                placeholder="Person's Phone"
                value={otherContact.phone}
                onChange={(e) => setOtherContact({ ...otherContact, phone: e.target.value })}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                required
              />
            </div>
          )}
        </div>

        {/* Scheduled Date */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Scheduled Date & Time (Optional)</label>
          <input
            type="datetime-local"
            value={formData.scheduled_date}
            onChange={(e) => setFormData({ ...formData, scheduled_date: e.target.value })}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
          />
        </div>

        {/* User Quoted Price (Optional) */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Your Preferred Price (Optional)</label>
          <input
            type="number"
            min="0"
            step="0.01"
            value={formData.user_quoted_price}
            onChange={(e) => setFormData({ ...formData, user_quoted_price: e.target.value })}
            placeholder="Enter your preferred price"
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
          />
          <p className="text-xs text-gray-500 mt-1">Provider can accept or counter your offer</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button
            type="button"
            disabled={quoteLoading}
            onClick={handleRateQuote}
            className="w-full px-4 py-3 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 disabled:opacity-50"
          >
            {quoteLoading ? 'Requesting...' : 'Request Rate Quote'}
          </button>
          <button
            type="submit"
            disabled={submitting}
            className="w-full px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {submitting ? 'Creating Booking...' : 'Create Booking'}
          </button>
        </div>
      </form>
        </div >
      </div >
    )
}

